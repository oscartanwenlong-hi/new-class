<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆä»ªè¡¨ç›˜</title>
    <script type="module">
        // âœ… Firebase é…ç½®
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJlO3qAn54oGa1T8Jwhj8O20ZUZeLE4wI",
            authDomain: "my-learning-platform-e2f91.firebaseapp.com",
            projectId: "my-learning-platform-e2f91",
            storageBucket: "my-learning-platform-e2f91.appspot.com",
            messagingSenderId: "963544469209",
            appId: "1:963544469209:web:145e652a6f9fc234a7b8c8",
            measurementId: "G-51RWYK9K4Q"
        };

        // âœ… åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        // âœ… ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert("è¯·å…ˆç™»å½•ï¼");
                window.location.href = "login.html";
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯æ•™å¸ˆ
            const userRef = collection(db, "user");
            const querySnapshot = await getDocs(userRef);
            let isTeacher = false;

            querySnapshot.forEach((doc) => {
                if (doc.id === user.uid && doc.data().role === "æ•™å¸ˆ") {
                    isTeacher = true;
                }
            });

            if (!isTeacher) {
                alert("ä½ æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢ï¼");
                window.location.href = "index.html";
            }
        });

        // âœ… æ·»åŠ è¯¾ç¨‹
        window.addCourse = async function () {
            const courseTitle = document.getElementById("courseTitle").value;
            const courseContent = document.getElementById("courseContent").value;

            if (!courseTitle || !courseContent) {
                alert("è¯·è¾“å…¥è¯¾ç¨‹æ ‡é¢˜å’Œå†…å®¹ï¼");
                return;
            }

            try {
                await addDoc(collection(db, "courses"), {
                    title: courseTitle,
                    content: courseContent,
                    createdBy: auth.currentUser.uid,
                    createdAt: new Date()
                });

                alert("è¯¾ç¨‹æ·»åŠ æˆåŠŸï¼Œæ‰€æœ‰å­¦ç”Ÿéƒ½å¯ä»¥è®¿é—®ï¼");
                document.getElementById("courseTitle").value = "";
                document.getElementById("courseContent").value = "";
            } catch (error) {
                console.error("æ·»åŠ è¯¾ç¨‹å¤±è´¥: ", error);
                alert("æ·»åŠ è¯¾ç¨‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™ï¼");
            }
        };
    </script>
</head>
<body>
    <h1>æ•™å¸ˆä»ªè¡¨ç›˜</h1>
    <h2>æ·»åŠ è¯¾ç¨‹</h2>

    <label for="courseTitle">è¯¾ç¨‹æ ‡é¢˜:</label>
    <input type="text" id="courseTitle" placeholder="è¾“å…¥è¯¾ç¨‹æ ‡é¢˜">
    
    <label for="courseContent">è¯¾ç¨‹å†…å®¹:</label>
    <textarea id="courseContent" placeholder="è¾“å…¥è¯¾ç¨‹å†…å®¹"></textarea>

    <button onclick="addCourse()">æ·»åŠ è¯¾ç¨‹</button>

    <h2>å·²å‘å¸ƒè¯¾ç¨‹</h2>
    <ul id="courseList"></ul>

    <script type="module">
        // âœ… åŠ è½½å·²å‘å¸ƒè¯¾ç¨‹
        import { getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        async function loadCourses() {
            const courseList = document.getElementById("courseList");
            courseList.innerHTML = "";

            const coursesSnapshot = await getDocs(collection(db, "courses"));
            coursesSnapshot.forEach((doc) => {
                const course = doc.data();
                const li = document.createElement("li");
                li.textContent = `ğŸ“– ${course.title} - å‘å¸ƒè€…: ${course.createdBy}`;
                courseList.appendChild(li);
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        loadCourses();
    </script>
</body>
</html>
